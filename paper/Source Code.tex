% Taken from Stack Overflow

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{ltblue}{rgb}{0,0.4,0.4}
\definecolor{dkviolet}{rgb}{0.3,0,0.5}

% lstlisting coq style (inspired from a file of Assia Mahboubi)
\lstdefinelanguage{Coq}{ 
    % Anything betweeen $ becomes LaTeX math mode
    mathescape=true,
    % Comments may or not include Latex commands
    texcl=false, 
    % Vernacular commands
    morekeywords=[1]{Section, Module, End, Require, Import, Export,
        Variable, Variables, Parameter, Parameters, Axiom, Hypothesis,
        Hypotheses, Notation, Local, Tactic, Reserved, Scope, Open, Close,
        Bind, Delimit, Definition, Let, Ltac, Fixpoint, CoFixpoint, Add,
        Morphism, Relation, Implicit, Arguments, Unset, Contextual,
        Strict, Prenex, Implicits, Inductive, CoInductive, Record,
        Structure, Canonical, Coercion, Context, Class, Global, Instance,
        Program, Infix, Theorem, Lemma, Corollary, Proposition, Fact,
        Remark, Example, Proof, Goal, Save, Qed, Defined, Hint, Resolve,
        Rewrite, View, Search, Show, Print, Printing, All, Eval, Check,
        Projections, inside, outside, Def},
    % Gallina
    morekeywords=[2]{forall, exists, exists2, fun, fix, cofix, struct,
        match, with, end, as, in, return, let, if, is, then, else, for, of,
        nosimpl, when},
    % Sorts
    morekeywords=[3]{Type, Prop, Set, true, false, option},
    % Various tactics, some are std Coq subsumed by ssr, for the manual purpose
    morekeywords=[4]{pose, set, move, case, elim, apply, clear, hnf,
        intro, intros, generalize, rename, pattern, after, destruct,
        induction, using, refine, inversion, injection, rewrite, congr,
        unlock, compute, ring, field, fourier, replace, fold, unfold,
        change, cutrewrite, simpl, have, suff, wlog, suffices, without,
        loss, nat_norm, assert, cut, trivial, revert, bool_congr, nat_congr,
        symmetry, transitivity, auto, split, left, right, autorewrite},
    % Terminators
    morekeywords=[5]{by, done, exact, reflexivity, tauto, romega, omega,
        assumption, solve, contradiction, discriminate},
    % Control
    morekeywords=[6]{do, last, first, try, idtac, repeat},
    % Comments delimiters, we do turn this off for the manual
    morecomment=[s]{(*}{*)},
    % Spaces are not displayed as a special character
    showstringspaces=false,
    % String delimiters
    morestring=[b]",
    morestring=[d]â€™,
    % Size of tabulations
    tabsize=3,
    % Enables ASCII chars 128 to 255
    extendedchars=false,
    % Case sensitivity
    sensitive=true,
    % Automatic breaking of long lines
    breaklines=false,
    % Default style fors listings
    basicstyle=\small,
    % Position of captions is bottom
    captionpos=b,
    % flexible columns
    columns=[l]flexible,
    % Style for (listings') identifiers
    identifierstyle={\ttfamily\color{black}},
    % Style for declaration keywords
    keywordstyle=[1]{\ttfamily\color{violet}},
    % Style for gallina keywords
    keywordstyle=[2]{\ttfamily\color{green}},
    % Style for sorts keywords
    keywordstyle=[3]{\ttfamily\color{ltblue}},
    % Style for tactics keywords
    keywordstyle=[4]{\ttfamily\color{blue}},
    % Style for terminators keywords
    keywordstyle=[5]{\ttfamily\color{red}},
    %Style for iterators
    %keywordstyle=[6]{\ttfamily\color{dkpink}},
    % Style for strings
    stringstyle=\ttfamily,
    % Style for comments
    commentstyle={\ttfamily\color{dkgreen}},
    %moredelim=**[is][\ttfamily\color{red}]{/&}{&/},
    literate=
    {\\forall}{{\color{dkgreen}{$\forall\;$}}}1
    {\\exists}{{$\exists\;$}}1
    {<-}{{$\leftarrow\;$}}1
    {=>}{{$\Rightarrow\;$}}1
    {==}{{\code{==}\;}}1
    {==>}{{\code{==>}\;}}1
    %    {:>}{{\code{:>}\;}}1
    {->}{{$\rightarrow\;$}}1
    {<->}{{$\leftrightarrow\;$}}1
    {<==}{{$\leq\;$}}1
    {\#}{{$^\star$}}1 
    {\\o}{{$\circ\;$}}1 
    {\@}{{$\cdot$}}1 
    {\/\\}{{$\wedge\;$}}1
    {\\\/}{{$\vee\;$}}1
    {++}{{\code{++}}}1
    {~}{{$\sim$}}1
    {\@\@}{{$@$}}1
    {\\mapsto}{{$\mapsto\;$}}1
    {\\hline}{{\rule{\linewidth}{0.5pt}}}1
    %
}[keywords,comments,strings]

\section{fix-print Source Code}
\label{appendix:Source-Code}

\begin{lstlisting}[language=Coq]
    Require Import String.
    Require Import List.
    Import ListNotations.
    Require Import Coq.Program.Wf.
    Require Import Extraction.
    Require Import ExtrOcamlBasic.
    Require Import ExtrOcamlNativeString.

    Inductive leaf : Type :=
    | ENDMARKER : leaf
    | NAME : string -> leaf
    | NUMBER : string -> leaf
    | STRING : string -> leaf
    | NEWLINE : leaf
    | INDENT : leaf
    | DEDENT : leaf
    | LPAR : leaf
    | RPAR : leaf
    | LSQB : leaf
    | RSQB : leaf
    | COLON : leaf
    | COMMA : leaf
    | SEMI : leaf
    | PLUS : leaf
    | MINUS : leaf
    | STAR : leaf
    | SLASH : leaf
    | VBAR : leaf
    | AMPER : leaf
    | LESS : leaf
    | GREATER : leaf
    | EQUAL : leaf
    | DOT : leaf
    | PERCENT : leaf
    | BACKQUOTE : leaf
    | LBRACE : leaf
    | RBRACE : leaf
    | EQEUQAL : leaf
    | NOTEQUAL : leaf
    | LESSEQUAL : leaf
    | GREATEREQUAL : leaf
    | TILDE : leaf
    | CIRCUMFLEX : leaf
    | LEFTSHIFT : leaf
    | RIGHTSHIFT : leaf
    | DOUBLESTAR : leaf
    | PLUSEQUAL : leaf
    | MINEQUAL : leaf
    | STAREQUAL : leaf
    | SLASHEQUAL : leaf
    | PERCENTEQUAL : leaf
    | AMPEREQUAL : leaf
    | VBAREQUAL : leaf
    | CIRCUMFLEXEQUAL : leaf
    | LEFTSHIFTEQUAL : leaf
    | RIGHTSHIFTEQUAL : leaf
    | DOUBLESTAREQUAL : leaf
    | DOUBLESLASH : leaf
    | DOUBLESLASHEQUAL : leaf
    | AT : leaf
    | ATEQUAL : leaf
    | OP : leaf
    | COMMENT : string -> leaf
    | NL : leaf
    | RARROW : leaf
    | AWAIT : leaf
    | ASYNC : leaf
    | ERRORTOKEN : leaf
    | COLONEQUAL : leaf.

    Inductive tree : Type :=
    | LEAF : leaf -> tree
    | NODE : list tree -> tree.

    Fixpoint concat_strings (l : list string) : string :=
    match l with
    | [] => "" 
    | x :: xs => x ++ concat_strings xs
    end.

    Definition to_string (t : tree) : string :=
    match t with
    | LEAF (NAME n) => n
    | LEAF (NUMBER n) => n
    | LEAF (STRING s) => "'" ++ s ++ "'"
    | LEAF LPAR => "("
    | LEAF RPAR => ")"
    | LEAF COLON => ":"
    | LEAF COMMA => ","
    | LEAF SEMI => ";"
    | LEAF PLUS => "+"
    | LEAF MINUS => "-"
    | LEAF STAR => "*"
    | LEAF SLASH => "/"
    | LEAF AMPER => "&"
    | LEAF LESS => "<"
    | LEAF GREATER => ">"
    | LEAF EQUAL => "="
    | LEAF DOT => "."
    | LEAF PERCENT => "%"
    | LEAF BACKQUOTE => "`"
    | LEAF LBRACE => "{"
    | LEAF RBRACE => "}"
    | LEAF EQEUQAL => "=="
    | LEAF NOTEQUAL => "!="
    | LEAF LESSEQUAL => "<="
    | LEAF GREATEREQUAL => ">="
    | LEAF TILDE => "~"
    | LEAF CIRCUMFLEX => "^"
    | LEAF LEFTSHIFT => "<<"
    | LEAF RIGHTSHIFT => ">>"
    | LEAF DOUBLESTAR => "**"
    | LEAF PLUSEQUAL => "+="
    | LEAF MINEQUAL => "-="
    | LEAF STAREQUAL => "*="
    | LEAF SLASHEQUAL => "/="
    | LEAF PERCENTEQUAL => "%="
    | LEAF AMPEREQUAL => "&="
    | LEAF VBAREQUAL => "|="
    | LEAF CIRCUMFLEXEQUAL => "^="
    | LEAF LEFTSHIFTEQUAL => "<<="
    | LEAF RIGHTSHIFTEQUAL => ">>="
    | LEAF DOUBLESTAREQUAL => "**="
    | LEAF DOUBLESLASH => "//"
    | LEAF DOUBLESLASHEQUAL => "//="
    | LEAF AT => "@"
    | LEAF ATEQUAL => "@="
    | LEAF COLONEQUAL => ":="
    | _ => ""
    end.

    Definition fix_print (l : list tree) : list tree :=
    match l with
    | LEAF (NAME "print") :: n => LEAF (NAME "print") :: LEAF LPAR ::
        (match n with
        | LEAF RIGHTSHIFT :: LEAF (NAME f) :: n' => 
        match rev n' with
        | LEAF COMMA :: n'' => rev n'' ++  [LEAF COMMA ; LEAF (NAME "end") ; LEAF EQUAL ; LEAF (STRING " ") ; LEAF COMMA; 
            LEAF (NAME "file") ; LEAF EQUAL ; LEAF (NAME f)]
        | _ => match n' with
                | LEAF COMMA :: n'' => n' ++ [LEAF COMMA; LEAF (NAME "file") ; LEAF EQUAL ; LEAF (NAME f)]
                | _ => n' ++ [LEAF (NAME "file") ; LEAF EQUAL ; LEAF (NAME f)]
                end
        end
        | _ => match rev n with
        | LEAF COMMA :: n' => rev n' ++ [LEAF COMMA ; LEAF (NAME "end") ; LEAF EQUAL ; LEAF (STRING " ")]
        | _ => n
        end
        end) ++ [LEAF RPAR]
    | _ => [LEAF (NAME "print") ; LEAF LPAR ; LEAF RPAR]
    end.

    Lemma output_starts_with_print : forall n : list tree, 
        nth 0 (fix_print (LEAF (NAME "print") :: n)) (NODE []) = LEAF (NAME "print").
    destruct n.
    - simpl. reflexivity.
    - simpl. reflexivity.
    Qed.

    Lemma output_begins_with_parentheses : forall n : list tree,
        nth 1 ((fix_print (LEAF (NAME "print") :: n))) (NODE []) = LEAF LPAR.
    destruct n ; auto.
    Qed.

    Extraction "/home/user/fix-print/src/tests/fix-print.ml" fix_print.
\end{lstlisting}
